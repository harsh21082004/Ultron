@for (block of blocks; track $index) {
  <ng-container [ngSwitch]="block.type">

    <ng-container *ngSwitchCase="'text'">
      @if (sender === 'user') {
        @if (isLong(block.content)) {
          <div>
            <div class="user-text-simple" [class.truncate-lines]="!isExpanded($index)">
              {{ block.content }}
            </div>
            <button (click)="toggleExpand($index)" class="expand-button" [class.dark-mode]="isDarkMode()">
              {{ isExpanded($index) ? 'Show Less' : 'Show More' }}
            </button>
          </div>
        } @else {
          <div class="user-text-simple">{{ block.content }}</div>
        }
      } @else {
        <div class="prose" [class.dark-prose]="isDarkMode()">
            <app-streaming-text 
                [content]="$any(block.content)" 
                [sources]="sources || []">
            </app-streaming-text>
        </div>
      }
    </ng-container>

    <ng-container *ngSwitchCase="'image_url'">
        <div class="my-3 overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm max-w-sm group relative">
            <img [src]="$any(block.content)" 
                 alt="Uploaded Image" 
                 class="w-full h-auto object-cover max-h-64 cursor-zoom-in transition-opacity hover:opacity-90"
                 (click)="imageClick.emit($any(block.content))"
                 loading="lazy" height="20" width="20">
        </div>
    </ng-container>

    <ng-container *ngSwitchCase="'video'">
        <div class="my-4 w-full max-w-lg overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700 shadow-lg bg-black">
            <div class="relative w-full" style="padding-bottom: 56.25%;"> 
                <iframe 
                    class="absolute top-0 left-0 w-full h-full"
                    [src]="$any(block).youtubeUrl" 
                    title="YouTube video player" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
    </ng-container>

    <app-table-template-component *ngSwitchCase="'table'" 
                                  [data]="$any(block.content)">
    </app-table-template-component>

    <ng-container *ngSwitchCase="'code'">
      <div class="code-wrapper my-4 rounded-xl">
        <div class="flex justify-between items-center px-4 py-3 code-header">
          <span class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
            {{ $any(block.content).language || 'Code' }}
          </span>
          <button (click)="copyCode($any(block.content).code)"
                  class="flex items-center gap-1.5 text-xs">
            <mat-icon class="!w-[14px] !h-[14px] !text-[14px] leading-none">content_copy</mat-icon>
            <span>Copy</span> 
          </button>
        </div>
        <div class="code-body relative overflow-x-auto mt-0.5">
          <pre class="m-0 p-4"><code 
            [appHighlight]="$any(block.content).code" 
            [language]="$any(block.content).language" 
            [class.dark-theme]="isDarkMode()"
            [class.light-theme]="!isDarkMode()"
            class="text-sm font-mono leading-relaxed outline-none block"></code></pre>
        </div>
      </div>
    </ng-container>

  </ng-container>
}