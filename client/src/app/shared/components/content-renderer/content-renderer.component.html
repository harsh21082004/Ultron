@for (block of blocks; track $index) {
  <ng-container [ngSwitch]="block.type">

    <!-- TEXT BLOCK -->
    <ng-container *ngSwitchCase="'text'">
      @if (sender === 'user') {
        @if (isLong(block.content)) {
          <div>
            <div class="user-text-simple" [class.truncate-lines]="!isExpanded($index)">
              {{ block.content }}
            </div>
            <button (click)="toggleExpand($index)" class="expand-button" [class.dark-mode]="isDarkMode()">
              {{ isExpanded($index) ? 'Show Less' : 'Show More' }}
            </button>
          </div>
        } @else {
          <div class="user-text-simple">{{ block.content }}</div>
        }
      } @else {
        
        <div class="prose" [class.dark-prose]="isDarkMode()">
            <!-- UPDATED: Pass sources to streaming text -->
            <app-streaming-text 
                [content]="$any(block.content)" 
                [sources]="sources || []">
            </app-streaming-text>
        </div>

      }
    </ng-container>

    <!-- IMAGE BLOCK -->
    <ng-container *ngSwitchCase="'image_url'">
        <div class="my-3 overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm max-w-sm">
            <img [src]="$any(block.content)" 
                 alt="Uploaded Image" 
                 class="w-full h-auto object-cover max-h-64"
                 loading="lazy">
        </div>
    </ng-container>

    <!-- TABLE BLOCK -->
    <app-table-template-component *ngSwitchCase="'table'" 
                                  [data]="$any(block.content)">
    </app-table-template-component>

    <!-- CODE BLOCK -->
    <ng-container *ngSwitchCase="'code'">
      <div class="code-wrapper my-4 rounded-xl">
        <div class="flex justify-between items-center px-4 py-3 code-header">
          <span class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
            {{ $any(block.content).language || 'Code' }}
          </span>
          <button (click)="copyCode($any(block.content).code)"
                  class="flex items-center gap-1.5 text-xs">
            <mat-icon class="!w-[14px] !h-[14px] !text-[14px] leading-none">content_copy</mat-icon>
            <span>Copy</span> 
          </button>
        </div>
        <div class="code-body relative overflow-x-auto mt-0.5">
          <pre class="m-0 p-4"><code 
            [appHighlight]="$any(block.content).code" 
            [language]="$any(block.content).language" 
            [class.dark-theme]="isDarkMode()"
            [class.light-theme]="!isDarkMode()"
            class="text-sm font-mono leading-relaxed outline-none block"></code></pre>
        </div>
      </div>
    </ng-container>

  </ng-container>
}