@if (messages$ | async; as messages) {
<div class="flex flex-col h-[100%] w-full relative overflow-hidden">

  <!-- Fixed Header -->
  <app-header-component class="absolute top-0 w-[100%] z-20"></app-header-component>

  <!-- Scrollable Message Area -->
  <div #chatContainer class="w-full chat-container overflow-y-auto mt-15 h-full z-0">
    <div class="w-full max-w-4xl mx-auto p-6 space-y-6 pb-24 sm:pb-6">
      
      <!-- 1. EMPTY STATE (Delegated to Child Component) -->
      @if (messages.length === 0 && !(isLoading$ | async)) {
        <app-chat-empty-state
          [user]="user$ | async"
          [isMobileView]="isMobileView"
          [suggestions]="promptSuggestions"
          (suggestionClicked)="handleSuggestionClick($event)">
        </app-chat-empty-state>
      } 
      
      <!-- 2. MESSAGES LIST -->
      @else {
        @for (message of messages; track trackByMessage($index, message)){
          <div #messageElement class="flex items-start gap-2 group" 
               [class.justify-end]="message.sender === 'user'"
               [class.flex-col]="message.sender === 'ai'" 
               [class.items-start]="message.sender === 'ai'">

            <!-- User Actions (Edit/Copy) - Only visible on hover -->
            @if (message.sender === 'user') {
              <div class="flex-shrink-0 flex opacity-0 group-hover:opacity-100 transition-opacity">
                <button mat-icon-button matTooltip="Edit Message" (click)="onEditMessage(message)" class="action-btn">
                  <mat-icon class="small-icon">edit</mat-icon>
                </button>
                <button mat-icon-button matTooltip="Copy Text" (click)="onCopyMessage(message)" class="action-btn">
                  <mat-icon class="small-icon">content_copy</mat-icon>
                </button>
              </div>
            }

            <!-- AI Status Icon/Loader -->
            @if (message.sender === 'ai') {
              <div class="relative w-full h-11 flex-shrink-0 flex items-center">
                @if (message.isStreaming) {
                  <div class="absolute w-auto h-full">
                    <ultron-loader-component class="h-full w-auto flex"></ultron-loader-component>
                  </div>
                  <span class="ml-14 text-sm text-gray-500 animate-pulse">Thinking...</span>
                }
                <div class="absolute inset-0 w-6 h-6 rounded-full flex items-center justify-center ai-response">
                  <img src="assets/images/logo.svg" alt="Ultron Logo">
                </div>
              </div>
            }

            <!-- Message Bubble Content -->
            <div class="max-w-4xl py-2 px-4" 
                 [ngClass]="{
                   'user-bubble': message.sender === 'user',
                   'ai-bubble w-[100%]': message.sender === 'ai'
                 }">
                 
              <!-- Render Markdown/Code blocks -->
              @for (block of message.content; track $index) {
                <app-content-renderer-component 
                  [content]="block.value" 
                  [sender]="message.sender"
                  class="text-base">
                </app-content-renderer-component>
              }

              <!-- AI Actions (Like/Dislike/Copy) - Only visible on hover/streaming -->
              @if (message.sender === 'ai') {
                <div class="flex-shrink-0 flex group-hover:opacity-100 transition-opacity mt-2"
                     [class.opacity-0]="messages[messages.length - 1]._id !== message._id && !message.isStreaming">
                  <button mat-icon-button class="action-btn"><mat-icon class="small-icon">thumb_up</mat-icon></button>
                  <button mat-icon-button class="action-btn"><mat-icon class="small-icon">thumb_down</mat-icon></button>
                  <button mat-icon-button (click)="onCopyMessage(message)" class="action-btn"><mat-icon class="small-icon">content_copy</mat-icon></button>
                  <button mat-icon-button class="action-btn"><mat-icon class="small-icon">share</mat-icon></button>
                  <button mat-icon-button class="action-btn"><mat-icon class="small-icon">more_vert</mat-icon></button>
                </div>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- 3. INPUT AREA (Fixed Bottom - Delegated to Child Component) -->
  <div class="w-full max-w-4xl mx-auto p-4 pt-0 flex-shrink-0 z-10 bg-white/0">
    <app-chat-input
      [isLoading]="(isLoading$ | async) ?? false"
      [isStreaming]="(isStreaming$ | async) ?? false"
      (sendMessage)="handleSendMessage($event)"
      (stopGeneration)="handleStopGeneration()">
    </app-chat-input>
  </div>

</div>
}