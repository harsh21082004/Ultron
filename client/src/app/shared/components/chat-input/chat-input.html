<form [formGroup]="chatForm" (ngSubmit)="onSubmit()"
  class="chat-input-content rounded-2xl p-2 mt-4 sm:p-3 bg-[var(--mat-menu-container-color)] shadow-lg flex flex-col transition-shadow duration-200 focus-within:shadow-xl border border-white/5">

  <!-- 
    TIWARI JI: File Chips Section 
    Only visible when files are selected.
  -->
  @if (files.length > 0) {
    <div class="px-2 pb-2">
      <mat-chip-grid #chipGrid aria-label="Selected files">
        @for (file of files; track file.name) {
          <mat-chip-row (removed)="removeFile(file)" 
            class="!bg-black/5 dark:!bg-white/10 !text-xs !font-medium">
            
            <!-- Dynamic Icon based on file type -->
            <mat-icon matChipAvatar class="!text-gray-500 dark:!text-gray-300">
              {{ file.type.startsWith('image') ? 'image' : (file.type.startsWith('audio') ? 'mic' : 'description') }}
            </mat-icon>
            
            <!-- Truncate long filenames -->
            <span class="text-[var(--mat-sys-on-surface)]">
              {{ file.name | slice:0:20 }}{{ file.name.length > 20 ? '...' : '' }}
            </span>
            
            <button matChipRemove [attr.aria-label]="'remove ' + file.name">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
        }
      </mat-chip-grid>
    </div>
  }

  <!-- Text Input Area -->
  <textarea #chatTextarea formControlName="message" rows="1" placeholder="Message AI Chat..."
    class="w-full textarea bg-transparent resize-none px-3 sm:px-4 placeholder-gray-500 focus:outline-none text-[var(--mat-sys-on-surface)] max-h-[200px]"
    (keydown)="handleEnterPress($event)" appAutoGrow [appAutoGrowMaxLines]="6"></textarea>

  <!-- Actions Bar -->
  <div class="flex items-center justify-between mt-2 pt-1 border-t border-transparent">
    
    <!-- Left: Attachments -->
    <div class="flex items-center gap-1">
      <!-- Hidden Native Inputs -->
      <input type="file" #audioInput hidden accept="audio/*" (change)="onFileSelected($event)">
      <input type="file" #imageInput hidden multiple accept="image/*" (change)="onFileSelected($event)">
      <input type="file" #docInput hidden accept=".pdf,.txt,.doc,.docx,.csv" (change)="onFileSelected($event)">

      <button type="button" mat-icon-button (click)="audioInput.click()" matTooltip="Upload Audio"
        class="opacity-60 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/10 transition-all">
        <mat-icon class="!text-[20px] !flex items-center justify-center">mic</mat-icon>
      </button>
      
      <button type="button" mat-icon-button (click)="imageInput.click()" matTooltip="Upload Image"
        class="opacity-60 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/10 transition-all">
        <mat-icon class="!text-[20px] !font-bold rotate-45 flex items-center justify-center">attach_file</mat-icon>
      </button>
      
      <button type="button" mat-icon-button (click)="docInput.click()" matTooltip="Upload Document"
        class="opacity-60 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/10 transition-all">
        <mat-icon class="!text-[20px] !flex items-center justify-center">search</mat-icon>
      </button>
    </div>

    <!-- Right: Model Select & Send -->
    <div class="right flex items-center gap-2">
      <!-- Model Dropdown -->
      <button type="button" [matMenuTriggerFor]="modelMenu" mat-button 
        class="!px-3 !min-w-0 !rounded-full opacity-80 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/5 text-[var(--mat-sys-on-surface)]">
        <span class="text-sm font-medium mr-1">Pro</span>
        <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">keyboard_arrow_down</mat-icon>
      </button>
      
      <mat-menu #modelMenu="matMenu" class="!rounded-xl !min-w-[220px]">
         <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Select Model</div>
         <button mat-menu-item>
            <mat-icon>psychology</mat-icon>
            <span>Thinking (DeepSeek)</span>
         </button>
         <button mat-menu-item>
            <mat-icon>flash_on</mat-icon>
            <span>Fast (Llama 3.3)</span>
         </button>
         <button mat-menu-item>
            <mat-icon>bolt</mat-icon>
            <span>Light (Llama 8B)</span>
         </button>
      </mat-menu>

      <!-- Send / Stop Button -->
      @if (isStreaming) {
        <button type="button" mat-mini-fab (click)="onStop()" matTooltip="Stop generating" class="!bg-red-500 !rounded-full !cursor-pointer !hover:bg-red-600 !dark:hover:bg-red-700">
          <img src="assets/images/stop.svg" height="20" width="20" class="w-4 h-4 dark:invert-0 invert" alt="stop">
        </button>
      } @else {
        <button type="submit" mat-mini-fab class="!rounded-full !cursor-pointer !hover:bg-black/5 !dark:hover:bg-white/10"
            [disabled]="!chatForm.value.message?.trim() && files.length === 0"
            aria-label="Send message">
            <img src="assets/images/send.svg" height="20" width="20" class="dark:invert-0 invert" alt="send">
        </button>
      }
    </div>
  </div>
</form>